{% extends "index.html" %}

{% block title %}Trang chủ{% endblock %}

{% block pagecontent %}
<div class="title">Chọn phương pháp</div>
<div class="method-container mb-3" id="choose-method">
  <p>
    <label class="radio">
      <input type="radio" name="method" value="decisiontree" checked>
      Decision tree
    </label>
  </p>
  <p>
    <label class="radio">
      <input type="radio" name="method" value="randomforest">
      Random forest
    </label>
  </p>
</div>

<div class="title">Phương pháp training và đánh giá</div>
<div class="train-test-container mb-3" id="choose-traintest">
  <label class="radio">
    <input type="radio" name="traintest" value="split" checked>
    Train/Test Split
  </label>
  <span class="ml-5">Train:</span>
  <span>
    <input id="splittrain" class="input is-small" style="width: 5%;" type="number" min="0" max="100"
      placeholder="Train">
  </span>
  <span>Test:</span>
  <span id="splittest"></span>
</div>

<p class="mb-3">
  <button class="button is-dark" id="process-button">Xử lí</button>
</p>

<div class="accuracy is-hidden mb-3" id="accuracy-report">
  <div class="title">Confusion Matrix</div>
  <div>
    <table class="table">
      {%for row in confusion_matrix%}
      <tr>
        {%for col in row%}
        <td>{{ col }}</td>
        {%endfor%}
      </tr>
      {%endfor%}
    </table>
  </div>

  <div class="title">Accuracy Score</div>
  <div>{{accuracy_score}}</div>

  <div class="title">Classification Report</div>
  <div class="table-container" style="max-height: 300px; overflow: auto;">
    <table class="table">
      <tr>
        <td></td>
        <td>Precision</td>
        <td>Recall</td>
        <td>F1 Ccore</td>
        <td>Support</td>
      </tr>
      {% for key, values in classification_report.items() %}
      <tr>
        <td>{{ key }}</td>
        <td>{{ values.precision }}</td>
        <td>{{ values.recall }}</td>
        <td>{{ values.f1score }}</td>
        <td>{{ values.support }}</td>
      </tr>
      {% endfor%}
    </table>
  </div>
</div>

<p class="mb-3">
  <button class="button is-dark" id="classification-button">Phân lớp</button>
</p>

<script>
  document.getElementById("datainput").classList.remove("is-active");
  document.getElementById("datapreprocess").classList.add("is-active");
  document.getElementById("dataprocess").classList.remove("is-active");

  currentSelection();
  classificationEvent();

  function classificationEvent() {
    document.getElementById("classification-button").addEventListener("click", function () {
      var href = window.location.href;
      var href = href.split("/");

      chosenData = href[4];
      chosenImputation = href[5];
      chosenMethod = href[6];
      chosenTraintest = href[7];
      value = href[8];

      setTimeout(function () {
        var href = "/choosedatapredict" + "/" + chosenData + "/" + chosenImputation + "/" + chosenMethod + "/" + chosenTraintest + "/" + value;
        window.location.href = href;
      }, 500);
    })
  }

  function currentSelection() {
    console.log('check current selection');
    var href = window.location.href;
    var href = href.split("/");

    for (var i = 0; i < href.length; i++) {
      if (href[i] == "choosedatapreprocess") {
        hadSelected(href, i);
        break;
      }
      if (href[i] == "choosedatatrain") {
        document.getElementById("accuracy-report").classList.remove("is-hidden");
        chosenMethod = href[i+3];
        chosenTraintest = href[i+4];
        value = href[i+5];
        selectOldOptions(chosenMethod, chosenTraintest, value);
      }

    }
  }

  function selectOldOptions(chosenMethod, chosenTraintest, value) {
    var chooseMethod = document.getElementById("choose-method").getElementsByTagName("input");
      for (var i = 0; i < chooseMethod.length; i++) {
        if (chooseMethod[i].value == chosenMethod) {
          chooseMethod[i].checked = true;
        }
      }
      var chooseTraintest = document.getElementById("choose-traintest").getElementsByTagName("input");
      for (var i = 0; i < chooseTraintest.length; i++) {
        if (chooseTraintest[i].value == chosenTraintest) {
          chooseTraintest[i].checked = true;
        }
      }
      document.getElementById("splittrain").value = value;
  }

  function hadSelected(href, hrefindex) {
    chosenData = href[hrefindex + 1];
    chosenImputation = href[hrefindex + 2];
    trainEvent(chosenData, chosenImputation);
  }

  function trainEvent(chosenData, chosenImputation) {
    document.getElementById("process-button").addEventListener('click', function () {
      var chosenMethod = null;
      var chooseMethod = document.getElementById("choose-method").getElementsByTagName("input");
      for (var i = 0; i < chooseMethod.length; i++) {
        if (chooseMethod[i].checked) {
          chosenMethod = chooseMethod[i].value;
        }
      }

      var chosenTraintest = null;
      var chooseTraintest = document.getElementById("choose-traintest").getElementsByTagName("input");
      for (var i = 0; i < chooseTraintest.length; i++) {
        if (chooseTraintest[i].checked) {
          chosenTraintest = chooseTraintest[i].value;
        }
      }
      var value = null;
      if (chosenTraintest == "split") {
        value = document.getElementById("splittrain").value;
        if (value == "") {
          value = "20";
        }
      }
      setTimeout(function () {
        var href = "/choosedatatrain" + "/" + chosenData + "/" + chosenImputation + "/" + chosenMethod + "/" + chosenTraintest + "/" + value;
        window.location.href = href;
      }, 500);
    })
  }
</script>
{% endblock %}